---
# Copyright 2015, Rackspace US, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

- name: Old conf removal
  hosts: hosts
  gather_facts: true
  user: root
  tasks:
    - name: Remove pip.conf
      file:
        path: "{{ ansible_env.HOME }}/.pip/pip.conf"
        state: "absent"

    - name: Remove 00apt-cacher-proxy
      file:
        path: "/etc/apt/apt.conf.d/00apt-cacher-proxy"
        state: "absent"

    - name: Copy global requirement global-requirement-pins
      copy:
        src: /opt/leap42/openstack-ansible-{{ release_version }}/global-requirement-pins.txt
        dest: /tmp/global-requirement-pins.txt

    - name: Upgrade and unify pip everywhere
      shell: |
        wget https://raw.githubusercontent.com/pypa/get-pip/430ba37776ae2ad89f794c7a43b90dc23bac334c/get-pip.py -O /opt/get-pip.py
        rm -rf /usr/local/lib/python2.7/dist-packages/{setuptools,wheel,pip,distutils,packaging}*
        python /opt/get-pip.py pip setuptools wheel \
          --force-reinstall \
          --upgrade \
          --constraint /tmp/global-requirement-pins.txt
